<Window
    x:Class="VPM.Windows.HubBrowserWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:VPM.Windows"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:wv2="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
    Title="VPM - Hub Browser"
    Width="1400"
    Height="900"
    Background="#FF202020"
    WindowStartupLocation="CenterOwner"
    mc:Ignorable="d">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />

        <!--  Converter to hide null/empty strings  -->
        <local:NullOrEmptyToVisibilityConverter x:Key="NullToVis" />

        <!--  Converter for cached Hub images  -->
        <local:CachedHubImageConverter x:Key="CachedHubImageConverter" />

        <!--  Dark theme colors  -->
        <SolidColorBrush x:Key="DarkBackground" Color="#1E1E1E" />
        <SolidColorBrush x:Key="DarkCardBackground" Color="#2D2D2D" />
        <SolidColorBrush x:Key="DarkBorder" Color="#3F3F3F" />
        <SolidColorBrush x:Key="DarkText" Color="#E0E0E0" />
        <SolidColorBrush x:Key="DarkTextSecondary" Color="#A0A0A0" />
        <SolidColorBrush x:Key="DarkControlBackground" Color="#333333" />
        <SolidColorBrush x:Key="DarkHover" Color="#404040" />

        <!--  ComboBox dark style with full template  -->
        <Style TargetType="ComboBox">
            <Setter Property="Background" Value="{StaticResource DarkControlBackground}" />
            <Setter Property="Foreground" Value="{StaticResource DarkText}" />
            <Setter Property="BorderBrush" Value="{StaticResource DarkBorder}" />
            <Setter Property="Padding" Value="6,4" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ComboBox">
                        <Grid>
                            <ToggleButton
                                x:Name="ToggleButton"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="1"
                                Focusable="False"
                                IsChecked="{Binding IsDropDownOpen, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}">
                                <ToggleButton.Template>
                                    <ControlTemplate TargetType="ToggleButton">
                                        <Border
                                            Background="{TemplateBinding Background}"
                                            BorderBrush="{TemplateBinding BorderBrush}"
                                            BorderThickness="{TemplateBinding BorderThickness}"
                                            CornerRadius="3">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition />
                                                    <ColumnDefinition Width="20" />
                                                </Grid.ColumnDefinitions>
                                                <Path
                                                    x:Name="Arrow"
                                                    Grid.Column="1"
                                                    HorizontalAlignment="Center"
                                                    VerticalAlignment="Center"
                                                    Data="M 0 0 L 4 4 L 8 0 Z"
                                                    Fill="{StaticResource DarkText}" />
                                            </Grid>
                                        </Border>
                                    </ControlTemplate>
                                </ToggleButton.Template>
                            </ToggleButton>
                            <ContentPresenter
                                x:Name="ContentSite"
                                Margin="6,3,23,3"
                                HorizontalAlignment="Left"
                                VerticalAlignment="Center"
                                Content="{TemplateBinding SelectionBoxItem}"
                                ContentTemplate="{TemplateBinding SelectionBoxItemTemplate}"
                                IsHitTestVisible="False"
                                TextBlock.Foreground="{StaticResource DarkText}" />
                            <Popup
                                x:Name="Popup"
                                AllowsTransparency="True"
                                Focusable="False"
                                IsOpen="{TemplateBinding IsDropDownOpen}"
                                Placement="Bottom"
                                PopupAnimation="Slide">
                                <Border
                                    x:Name="DropDownBorder"
                                    MinWidth="{TemplateBinding ActualWidth}"
                                    MaxHeight="{TemplateBinding MaxDropDownHeight}"
                                    Background="#FF2B2B2B"
                                    BorderBrush="{StaticResource DarkBorder}"
                                    BorderThickness="1"
                                    CornerRadius="3">
                                    <ScrollViewer Margin="2" SnapsToDevicePixels="True">
                                        <StackPanel IsItemsHost="True" KeyboardNavigation.DirectionalNavigation="Contained" />
                                    </ScrollViewer>
                                </Border>
                            </Popup>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!--  ComboBoxItem dark style  -->
        <Style TargetType="ComboBoxItem">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Foreground" Value="{StaticResource DarkText}" />
            <Setter Property="Padding" Value="6,4" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ComboBoxItem">
                        <Border
                            x:Name="Bd"
                            Padding="{TemplateBinding Padding}"
                            Background="{TemplateBinding Background}"
                            CornerRadius="2">
                            <ContentPresenter />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsHighlighted" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#FF404040" />
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#FF4A4A4A" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!--  TextBox dark style  -->
        <Style TargetType="TextBox">
            <Setter Property="Background" Value="{StaticResource DarkControlBackground}" />
            <Setter Property="Foreground" Value="{StaticResource DarkText}" />
            <Setter Property="BorderBrush" Value="{StaticResource DarkBorder}" />
            <Setter Property="CaretBrush" Value="{StaticResource DarkText}" />
        </Style>

        <!--  Button dark style with white border hover  -->
        <Style TargetType="Button">
            <Setter Property="Background" Value="{StaticResource DarkControlBackground}" />
            <Setter Property="Foreground" Value="{StaticResource DarkText}" />
            <Setter Property="BorderBrush" Value="{StaticResource DarkBorder}" />
            <Setter Property="Padding" Value="8,4" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border
                            x:Name="border"
                            Padding="{TemplateBinding Padding}"
                            Background="{TemplateBinding Background}"
                            BorderBrush="{TemplateBinding BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="3">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#FF454545" />
                                <Setter TargetName="border" Property="BorderBrush" Value="#FFFFFFFF" />
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Background" Value="#FF555555" />
                                <Setter TargetName="border" Property="BorderBrush" Value="#FFCCCCCC" />
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Background" Value="#FF2A2A2A" />
                                <Setter Property="Foreground" Value="#FF666666" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!--  CheckBox dark style  -->
        <Style TargetType="CheckBox">
            <Setter Property="Foreground" Value="{StaticResource DarkText}" />
        </Style>

        <!--  ScrollViewer dark style  -->
        <Style TargetType="ScrollViewer">
            <Setter Property="Background" Value="Transparent" />
        </Style>

        <!--  Border style - prevent default styling  -->
        <Style TargetType="Border">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderBrush" Value="Transparent" />
        </Style>

        <!--  ProgressBar dark style  -->
        <Style TargetType="ProgressBar">
            <Setter Property="Background" Value="#FF2B2B2B" />
            <Setter Property="Foreground" Value="#FF4A90D9" />
            <Setter Property="BorderBrush" Value="{StaticResource DarkBorder}" />
        </Style>

        <!--  Detail Tab Style for navigation tabs  -->
        <Style x:Key="DetailTabStyle" TargetType="RadioButton">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Foreground" Value="{StaticResource DarkTextSecondary}" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="Padding" Value="12,8" />
            <Setter Property="Margin" Value="0,0,4,0" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="RadioButton">
                        <Border
                            x:Name="border"
                            Padding="{TemplateBinding Padding}"
                            Background="{TemplateBinding Background}"
                            BorderBrush="{TemplateBinding BorderBrush}"
                            BorderThickness="0,0,0,2"
                            CornerRadius="4,4,0,0">
                            <ContentPresenter
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                TextBlock.Foreground="{TemplateBinding Foreground}" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#353535" />
                                <Setter Property="Foreground" Value="{StaticResource DarkText}" />
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter Property="Background" Value="#404040" />
                                <Setter Property="Foreground" Value="{StaticResource DarkText}" />
                                <Setter TargetName="border" Property="BorderBrush" Value="#4A90D9" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <!--  Overview Panel (Left)  -->
            <ColumnDefinition
                x:Name="OverviewPanelColumn"
                Width="0"
                MinWidth="0" />
            <!--  Splitter  -->
            <ColumnDefinition Width="Auto" />
            <!--  Main Content + Detail Panel  -->
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <!--  Overview Panel (Left Side - WebView2)  -->
        <Grid
            x:Name="OverviewPanel"
            Grid.Column="0"
            Background="#1A1A1A">
            <!--  Toggle Tab Button - positioned on right edge  -->
            <Button
                x:Name="ToggleOverviewPanelButton"
                Width="20"
                Height="60"
                Margin="0,0,-10,0"
                Padding="0"
                HorizontalAlignment="Right"
                VerticalAlignment="Center"
                Panel.ZIndex="100"
                Background="#404040"
                BorderBrush="{StaticResource DarkBorder}"
                BorderThickness="0,1,1,1"
                Click="ToggleOverviewPanel_Click"
                Content="â—€"
                FontSize="10"
                ToolTip="Hide overview panel">
                <Button.Resources>
                    <Style TargetType="Border">
                        <Setter Property="CornerRadius" Value="0,4,4,0" />
                    </Style>
                </Button.Resources>
            </Button>

            <Grid Margin="0,0,12,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!--  Overview Header  -->
                <Border
                    Grid.Row="0"
                    Padding="8"
                    Background="#252525"
                    BorderBrush="{StaticResource DarkBorder}"
                    BorderThickness="0,0,0,1">
                    <!--  Tab Navigation  -->
                    <StackPanel Orientation="Horizontal">
                        <RadioButton
                            x:Name="TabOverview"
                            Click="OverviewTab_Click"
                            Content="ðŸ“„ Overview"
                            GroupName="OverviewTabs"
                            IsChecked="True"
                            Style="{StaticResource DetailTabStyle}" />
                        <RadioButton
                            x:Name="TabUpdates"
                            Click="OverviewTab_Click"
                            Content="ðŸ”„ Updates"
                            GroupName="OverviewTabs"
                            Style="{StaticResource DetailTabStyle}" />
                        <RadioButton
                            x:Name="TabReviews"
                            Click="OverviewTab_Click"
                            Content="â­ Reviews"
                            GroupName="OverviewTabs"
                            Style="{StaticResource DetailTabStyle}" />
                        <RadioButton
                            x:Name="TabDiscussion"
                            Click="OverviewTab_Click"
                            Content="ðŸ’¬ Discussion"
                            GroupName="OverviewTabs"
                            Style="{StaticResource DetailTabStyle}" />
                    </StackPanel>
                </Border>

                <!--  WebView2 Content  -->
                <Grid Grid.Row="1">
                    <!--  Loading Overlay  -->
                    <Border
                        x:Name="WebViewLoadingOverlay"
                        Panel.ZIndex="10"
                        Background="#CC1E1E1E"
                        Visibility="Collapsed">
                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                            <TextBlock
                                HorizontalAlignment="Center"
                                FontSize="14"
                                Foreground="{StaticResource DarkText}"
                                Text="Loading..." />
                            <ProgressBar
                                Width="200"
                                Height="4"
                                Margin="0,12,0,0"
                                Background="#333333"
                                Foreground="#4A90D9"
                                IsIndeterminate="True" />
                        </StackPanel>
                    </Border>

                    <!--  WebView2 Browser  -->
                    <wv2:WebView2 x:Name="OverviewWebView" DefaultBackgroundColor="#1E1E1E" />

                    <!--  Placeholder when no resource selected  -->
                    <Border
                        x:Name="OverviewPlaceholder"
                        Background="{StaticResource DarkCardBackground}"
                        Visibility="Visible">
                        <StackPanel
                            Margin="20"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center">
                            <TextBlock
                                HorizontalAlignment="Center"
                                FontSize="48"
                                Foreground="{StaticResource DarkTextSecondary}"
                                Text="ðŸ“„" />
                            <TextBlock
                                Margin="0,12,0,0"
                                HorizontalAlignment="Center"
                                FontSize="14"
                                Foreground="{StaticResource DarkTextSecondary}"
                                Text="Select a resource to view its overview"
                                TextAlignment="Center"
                                TextWrapping="Wrap" />
                        </StackPanel>
                    </Border>

                    <!--  Error Panel  -->
                    <Border
                        x:Name="WebViewErrorPanel"
                        Background="{StaticResource DarkCardBackground}"
                        Visibility="Collapsed">
                        <StackPanel
                            Margin="20"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center">
                            <TextBlock
                                HorizontalAlignment="Center"
                                FontSize="48"
                                Foreground="{StaticResource DarkTextSecondary}"
                                Text="ðŸŒ" />
                            <TextBlock
                                x:Name="WebViewErrorText"
                                Margin="0,12,0,0"
                                HorizontalAlignment="Center"
                                FontSize="14"
                                Foreground="{StaticResource DarkText}"
                                Text="Unable to load content"
                                TextAlignment="Center"
                                TextWrapping="Wrap" />
                            <Button
                                x:Name="OpenInBrowserButton"
                                Margin="0,16,0,0"
                                Padding="16,8"
                                Click="OpenInBrowser_Click"
                                Content="ðŸ”— Open in Browser" />
                        </StackPanel>
                    </Border>
                </Grid>
            </Grid>
        </Grid>

        <!--  Resizable Splitter  -->
        <GridSplitter
            x:Name="OverviewSplitter"
            Grid.Column="1"
            Width="5"
            HorizontalAlignment="Center"
            VerticalAlignment="Stretch"
            Background="#3F3F3F"
            Cursor="SizeWE"
            Visibility="Collapsed" />

        <!--  Main Content + Detail Panel Area  -->
        <Grid Grid.Column="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition x:Name="DetailPanelColumn" Width="0" />
            </Grid.ColumnDefinitions>

            <!--  Resizable Splitter between Main Content and Detail Panel  -->
            <GridSplitter
                x:Name="DetailPanelSplitter"
                Grid.Column="1"
                Width="5"
                HorizontalAlignment="Center"
                VerticalAlignment="Stretch"
                Background="#3F3F3F"
                Cursor="SizeWE"
                Visibility="Collapsed" />

            <!--  Main Content Area  -->
            <Grid Grid.Column="0" Margin="8">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!--  Header with Search  -->
                <Grid Grid.Row="0" Margin="0,0,0,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <TextBlock
                        Grid.Column="0"
                        VerticalAlignment="Center"
                        FontSize="20"
                        FontWeight="Bold"
                        Foreground="{StaticResource DarkText}"
                        Text="ðŸŒ VaM Hub Browser" />

                    <StackPanel
                        Grid.Column="1"
                        VerticalAlignment="Center"
                        Orientation="Horizontal">
                        <TextBox
                            x:Name="SearchBox"
                            Width="250"
                            Height="28"
                            Margin="0,0,8,0"
                            Padding="4"
                            VerticalContentAlignment="Center"
                            KeyDown="SearchBox_KeyDown"
                            Text=""
                            TextChanged="SearchBox_TextChanged" />
                        <Button
                            x:Name="SearchButton"
                            Margin="0,0,12,0"
                            Padding="12,4"
                            Click="SearchButton_Click"
                            Content="ðŸ” Search" />
                        <Button
                            x:Name="RefreshButton"
                            Width="28"
                            Height="28"
                            Padding="0"
                            Click="RefreshButton_Click"
                            Content="ðŸ”„"
                            FontSize="14"
                            ToolTip="Refresh" />
                    </StackPanel>
                </Grid>

                <!--  Filters Row - Using WrapPanel for responsive wrapping  -->
                <WrapPanel
                    Grid.Row="1"
                    Margin="0,0,0,4"
                    VerticalAlignment="Center">
                    <!--  Hosted Option Filter  -->
                    <StackPanel
                        Margin="0,4,8,0"
                        VerticalAlignment="Center"
                        Orientation="Horizontal">
                        <TextBlock
                            Margin="0,0,4,0"
                            VerticalAlignment="Center"
                            Foreground="{StaticResource DarkText}"
                            Text="Source:" />
                        <ComboBox
                            x:Name="HostedOptionFilter"
                            Width="80"
                            SelectionChanged="Filter_SelectionChanged">
                            <ComboBoxItem Content="Hub And Dependencies" />
                            <ComboBoxItem Content="Hub Only" />
                            <ComboBoxItem Content="All" IsSelected="True" />
                        </ComboBox>
                    </StackPanel>

                    <!--  Category Filter  -->
                    <StackPanel
                        Margin="0,4,8,0"
                        VerticalAlignment="Center"
                        Orientation="Horizontal">
                        <TextBlock
                            Margin="0,0,4,0"
                            VerticalAlignment="Center"
                            Foreground="{StaticResource DarkText}"
                            Text="Category:" />
                        <ComboBox
                            x:Name="CategoryFilter"
                            Width="110"
                            SelectionChanged="Filter_SelectionChanged" />
                    </StackPanel>

                    <!--  Creator Filter with Searchable Popup  -->
                    <StackPanel
                        Margin="0,4,8,0"
                        VerticalAlignment="Center"
                        Orientation="Horizontal">
                        <TextBlock
                            Margin="0,0,4,0"
                            VerticalAlignment="Center"
                            Foreground="{StaticResource DarkText}"
                            Text="Creator:" />
                        <Grid>
                            <!--  Creator filter button with overlaid content  -->
                            <Border
                                x:Name="CreatorFilterBorder"
                                Width="160"
                                Height="26"
                                Background="{StaticResource DarkControlBackground}"
                                BorderBrush="{StaticResource DarkBorder}"
                                BorderThickness="1"
                                CornerRadius="3">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="20" />
                                    </Grid.ColumnDefinitions>
                                    <TextBlock
                                        x:Name="SelectedCreatorText"
                                        Grid.Column="0"
                                        Margin="6,0,0,0"
                                        VerticalAlignment="Center"
                                        Foreground="{StaticResource DarkText}"
                                        Text="All"
                                        TextTrimming="CharacterEllipsis" />
                                    <Path
                                        Grid.Column="1"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"
                                        Data="M 0 0 L 4 4 L 8 0 Z"
                                        Fill="{StaticResource DarkText}" />
                                </Grid>
                            </Border>

                            <!--  Invisible toggle button overlay  -->
                            <ToggleButton
                                x:Name="CreatorFilterToggle"
                                Width="160"
                                Height="26"
                                Checked="CreatorFilterToggle_Checked"
                                Opacity="0"
                                Unchecked="CreatorFilterToggle_Unchecked" />

                            <!--  Popup with search and list  -->
                            <Popup
                                x:Name="CreatorFilterPopup"
                                AllowsTransparency="True"
                                IsOpen="{Binding IsChecked, ElementName=CreatorFilterToggle}"
                                Placement="Bottom"
                                PlacementTarget="{Binding ElementName=CreatorFilterToggle}"
                                PopupAnimation="Slide"
                                StaysOpen="False">
                                <Border
                                    Width="220"
                                    MaxHeight="350"
                                    Background="#FF2B2B2B"
                                    BorderBrush="{StaticResource DarkBorder}"
                                    BorderThickness="1"
                                    CornerRadius="4">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="*" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>

                                        <!--  Search TextBox  -->
                                        <Grid Grid.Row="0" Margin="6">
                                            <TextBox
                                                x:Name="CreatorSearchBox"
                                                Height="26"
                                                Padding="6,4,24,4"
                                                VerticalContentAlignment="Center"
                                                Background="{StaticResource DarkControlBackground}"
                                                BorderBrush="{StaticResource DarkBorder}"
                                                CaretBrush="{StaticResource DarkText}"
                                                Foreground="{StaticResource DarkText}"
                                                TextChanged="CreatorSearchBox_TextChanged" />
                                            <TextBlock
                                                x:Name="CreatorSearchPlaceholder"
                                                Margin="8,0,0,0"
                                                VerticalAlignment="Center"
                                                Foreground="{StaticResource DarkTextSecondary}"
                                                IsHitTestVisible="False"
                                                Text="ðŸ” Search creators..."
                                                Visibility="{Binding Text.Length, ElementName=CreatorSearchBox, Converter={StaticResource BoolToVis}, ConverterParameter=Inverse}" />
                                        </Grid>

                                        <!--  Creator List  -->
                                        <ListBox
                                            x:Name="CreatorListBox"
                                            Grid.Row="1"
                                            MaxHeight="260"
                                            Margin="4,0,4,4"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                            SelectionChanged="CreatorListBox_SelectionChanged">
                                            <ListBox.ItemContainerStyle>
                                                <Style TargetType="ListBoxItem">
                                                    <Setter Property="Foreground" Value="{StaticResource DarkText}" />
                                                    <Setter Property="Padding" Value="8,6" />
                                                    <Setter Property="Cursor" Value="Hand" />
                                                    <Setter Property="Template">
                                                        <Setter.Value>
                                                            <ControlTemplate TargetType="ListBoxItem">
                                                                <Border
                                                                    x:Name="Bd"
                                                                    Padding="{TemplateBinding Padding}"
                                                                    Background="Transparent"
                                                                    CornerRadius="3">
                                                                    <ContentPresenter />
                                                                </Border>
                                                                <ControlTemplate.Triggers>
                                                                    <Trigger Property="IsMouseOver" Value="True">
                                                                        <Setter TargetName="Bd" Property="Background" Value="#FF404040" />
                                                                    </Trigger>
                                                                    <Trigger Property="IsSelected" Value="True">
                                                                        <Setter TargetName="Bd" Property="Background" Value="#FF4A90D9" />
                                                                    </Trigger>
                                                                </ControlTemplate.Triggers>
                                                            </ControlTemplate>
                                                        </Setter.Value>
                                                    </Setter>
                                                </Style>
                                            </ListBox.ItemContainerStyle>
                                        </ListBox>

                                        <!--  Creator count  -->
                                        <TextBlock
                                            x:Name="CreatorCountText"
                                            Grid.Row="2"
                                            Margin="8,4,8,6"
                                            FontSize="10"
                                            Foreground="{StaticResource DarkTextSecondary}"
                                            Text="0 creators" />
                                    </Grid>
                                </Border>
                            </Popup>
                        </Grid>

                        <!--  Clear creator button (outside the dropdown)  -->
                        <Button
                            x:Name="ClearCreatorButton"
                            Width="20"
                            Height="20"
                            Margin="4,0,0,0"
                            Padding="0"
                            VerticalAlignment="Center"
                            Background="Transparent"
                            BorderThickness="0"
                            Click="ClearCreatorFilter_Click"
                            Content="âœ•"
                            FontSize="11"
                            Foreground="{StaticResource DarkTextSecondary}"
                            ToolTip="Clear creator filter"
                            Visibility="Collapsed">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Border
                                                    x:Name="bd"
                                                    Background="{TemplateBinding Background}"
                                                    CornerRadius="4">
                                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="bd" Property="Background" Value="#FF555555" />
                                                        <Setter Property="Foreground" Value="White" />
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </Button.Style>
                        </Button>
                    </StackPanel>

                    <!--  Pay Type Filter  -->
                    <StackPanel
                        Margin="0,4,8,0"
                        VerticalAlignment="Center"
                        Orientation="Horizontal">
                        <TextBlock
                            Margin="0,0,4,0"
                            VerticalAlignment="Center"
                            Foreground="{StaticResource DarkText}"
                            Text="Type:" />
                        <ComboBox
                            x:Name="PayTypeFilter"
                            Width="75"
                            SelectionChanged="Filter_SelectionChanged">
                            <ComboBoxItem Content="Free" IsSelected="True" />
                            <ComboBoxItem Content="All" />
                            <ComboBoxItem Content="Paid" />
                        </ComboBox>
                    </StackPanel>

                    <!--  Sort  -->
                    <StackPanel
                        Margin="0,4,8,0"
                        VerticalAlignment="Center"
                        Orientation="Horizontal">
                        <TextBlock
                            Margin="0,0,4,0"
                            VerticalAlignment="Center"
                            Foreground="{StaticResource DarkText}"
                            Text="Sort:" />
                        <ComboBox
                            x:Name="SortFilter"
                            Width="140"
                            SelectionChanged="Filter_SelectionChanged" />
                    </StackPanel>

                    <!--  Secondary Sort  -->
                    <StackPanel
                        Margin="0,4,8,0"
                        VerticalAlignment="Center"
                        Orientation="Horizontal">
                        <TextBlock
                            Margin="0,0,4,0"
                            VerticalAlignment="Center"
                            Foreground="{StaticResource DarkText}"
                            Text="Then:" />
                        <ComboBox
                            x:Name="SortSecondaryFilter"
                            Width="110"
                            SelectionChanged="Filter_SelectionChanged" />
                    </StackPanel>

                    <!--  Tags Filter with Searchable Popup  -->
                    <StackPanel
                        Margin="0,4,8,0"
                        VerticalAlignment="Center"
                        Orientation="Horizontal">
                        <TextBlock
                            Margin="0,0,4,0"
                            VerticalAlignment="Center"
                            Foreground="{StaticResource DarkText}"
                            Text="Tags:" />
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="110" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <!--  Tags display/toggle  -->
                            <ToggleButton
                                x:Name="TagsFilterToggle"
                                Grid.Column="0"
                                Padding="8,4"
                                Background="{StaticResource DarkCardBackground}"
                                BorderBrush="{StaticResource DarkBorder}"
                                BorderThickness="1"
                                Checked="TagsFilterToggle_Checked"
                                Foreground="{StaticResource DarkText}"
                                Unchecked="TagsFilterToggle_Unchecked">
                                <TextBlock
                                    x:Name="TagsDisplayText"
                                    Text="All"
                                    TextTrimming="CharacterEllipsis" />
                            </ToggleButton>

                            <!--  Clear button  -->
                            <Button
                                Grid.Column="1"
                                Margin="6,0,0,0"
                                Padding="4,4"
                                Background="{StaticResource DarkCardBackground}"
                                BorderBrush="{StaticResource DarkBorder}"
                                BorderThickness="1"
                                Click="ClearTagsFilter_Click"
                                Content="âœ•"
                                FontSize="12"
                                Foreground="{StaticResource DarkText}" />

                            <!--  Tags search popup  -->
                            <Popup
                                x:Name="TagsFilterPopup"
                                Grid.Column="0"
                                AllowsTransparency="True"
                                IsOpen="{Binding IsChecked, ElementName=TagsFilterToggle, Mode=TwoWay}"
                                Placement="Bottom"
                                PlacementTarget="{Binding ElementName=TagsFilterToggle}"
                                StaysOpen="False">
                                <Border
                                    Background="{StaticResource DarkCardBackground}"
                                    BorderBrush="{StaticResource DarkBorder}"
                                    BorderThickness="1">
                                    <StackPanel Width="250">
                                        <!--  Search box  -->
                                        <TextBox
                                            x:Name="TagsSearchBox"
                                            Margin="4"
                                            Padding="6,4"
                                            Background="{StaticResource DarkBackground}"
                                            BorderBrush="{StaticResource DarkBorder}"
                                            BorderThickness="1"
                                            Foreground="{StaticResource DarkText}"
                                            TextChanged="TagsSearchBox_TextChanged" />

                                        <!--  Tags list  -->
                                        <ListBox
                                            x:Name="TagsListBox"
                                            MaxHeight="300"
                                            Margin="4"
                                            Background="{StaticResource DarkBackground}"
                                            BorderBrush="{StaticResource DarkBorder}"
                                            BorderThickness="1"
                                            Foreground="{StaticResource DarkText}"
                                            SelectionChanged="TagsListBox_SelectionChanged"
                                            SelectionMode="Multiple" />
                                    </StackPanel>
                                </Border>
                            </Popup>
                        </Grid>
                    </StackPanel>

                    <!--  Only Downloadable (disabled)  -->
                    <CheckBox
                        x:Name="OnlyDownloadableCheck"
                        Margin="0,0,12,0"
                        VerticalAlignment="Center"
                        Content="Only Downloadable"
                        Foreground="{StaticResource DarkText}"
                        IsChecked="False"
                        IsEnabled="False"
                        Visibility="Collapsed" />

                    <!--  Spacer to push buttons to the right  -->
                    <Border Width="0" />

                    <!--  Updates Panel Button  -->
                    <Button
                        x:Name="UpdatesPanelButton"
                        Margin="0,4,8,0"
                        Padding="10,4"
                        Click="UpdatesPanelButton_Click"
                        Content="â¬† Updates"
                        ToolTip="View available package updates" />

                    <!--  Missing Dependencies Button  -->
                    <Button
                        x:Name="MissingDepsPanelButton"
                        Margin="0,4,8,0"
                        Padding="10,4"
                        Click="MissingDepsPanelButton_Click"
                        Content="ðŸ”— Missing"
                        ToolTip="View missing dependencies" />
                </WrapPanel>

                <!--  Main Content - Resource Grid  -->
                <Border
                    Grid.Row="2"
                    Background="{StaticResource DarkCardBackground}"
                    BorderBrush="{StaticResource DarkBorder}"
                    BorderThickness="1"
                    CornerRadius="4">
                    <Grid>
                        <!--  Loading Indicator  -->
                        <StackPanel
                            x:Name="LoadingPanel"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Visibility="Collapsed">
                            <TextBlock
                                HorizontalAlignment="Center"
                                FontSize="16"
                                Foreground="{StaticResource DarkText}"
                                Text="Loading..." />
                            <ProgressBar
                                Width="200"
                                Height="20"
                                Margin="0,8,0,0"
                                IsIndeterminate="True" />
                        </StackPanel>

                        <!--  Resources List  -->
                        <ScrollViewer
                            x:Name="ResourcesScrollViewer"
                            HorizontalScrollBarVisibility="Disabled"
                            PreviewMouseWheel="ResourcesScrollViewer_PreviewMouseWheel"
                            VerticalScrollBarVisibility="Auto">
                            <ItemsControl x:Name="ResourcesItemsControl" SizeChanged="ResourcesItemsControl_SizeChanged">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <UniformGrid x:Name="ResourcesUniformGrid" Columns="4" />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border
                                            MinWidth="180"
                                            MaxWidth="320"
                                            Margin="2"
                                            Background="{StaticResource DarkControlBackground}"
                                            BorderBrush="{StaticResource DarkBorder}"
                                            BorderThickness="1"
                                            CornerRadius="4"
                                            Cursor="Hand"
                                            MouseLeftButtonDown="ResourceCard_Click">
                                            <Grid>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto" />
                                                    <RowDefinition Height="Auto" />
                                                </Grid.RowDefinitions>

                                                <!--  Thumbnail - Full size, not clipped  -->
                                                <Grid Grid.Row="0">
                                                    <Border Background="#20808080" CornerRadius="4,4,0,0">
                                                        <Image
                                                            MaxHeight="280"
                                                            local:CachedImageBehavior.ImageUrl="{Binding ImageUrl}"
                                                            Stretch="Uniform" />
                                                    </Border>

                                                    <!--  Top-right badges: In Library / Update / Recently Updated  -->
                                                    <StackPanel
                                                        Margin="4"
                                                        HorizontalAlignment="Right"
                                                        VerticalAlignment="Top"
                                                        Orientation="Horizontal">
                                                        <Border
                                                            Padding="4,2"
                                                            Background="#4CAF50"
                                                            CornerRadius="2"
                                                            Visibility="{Binding InLibrary, Converter={StaticResource BoolToVis}}">
                                                            <TextBlock
                                                                FontSize="11"
                                                                Foreground="White"
                                                                Text="âœ“ In Library" />
                                                        </Border>
                                                        <Border
                                                            Margin="4,0,0,0"
                                                            Padding="4,2"
                                                            Background="#FF9800"
                                                            CornerRadius="2"
                                                            Visibility="{Binding UpdateAvailable, Converter={StaticResource BoolToVis}}">
                                                            <TextBlock
                                                                FontSize="10"
                                                                Foreground="White"
                                                                Text="â¬† Update" />
                                                        </Border>
                                                    </StackPanel>

                                                    <!--  Top-left badges: External / Dependencies  -->
                                                    <StackPanel
                                                        Margin="4"
                                                        HorizontalAlignment="Left"
                                                        VerticalAlignment="Top"
                                                        Orientation="Horizontal">
                                                        <Border
                                                            Padding="4,2"
                                                            Background="#795548"
                                                            CornerRadius="2"
                                                            ToolTip="Requires external download"
                                                            Visibility="{Binding IsExternallyHosted, Converter={StaticResource BoolToVis}}">
                                                            <TextBlock
                                                                FontSize="10"
                                                                Foreground="White"
                                                                Text="ðŸ”— External" />
                                                        </Border>
                                                    </StackPanel>

                                                    <!--  Bottom-left: File size  -->
                                                    <Border
                                                        Margin="4"
                                                        Padding="4,2"
                                                        HorizontalAlignment="Left"
                                                        VerticalAlignment="Bottom"
                                                        Background="#80000000"
                                                        CornerRadius="2"
                                                        Visibility="{Binding FileSizeDisplay, Converter={StaticResource NullToVis}}">
                                                        <TextBlock
                                                            FontSize="11"
                                                            Foreground="White"
                                                            Text="{Binding FileSizeDisplay}" />
                                                    </Border>

                                                    <!--  Bottom-right: Last update time  -->
                                                    <Border
                                                        Margin="4"
                                                        Padding="4,2"
                                                        HorizontalAlignment="Right"
                                                        VerticalAlignment="Bottom"
                                                        Background="#80000000"
                                                        CornerRadius="2"
                                                        Visibility="{Binding LastUpdateDisplay, Converter={StaticResource NullToVis}}">
                                                        <TextBlock
                                                            FontSize="11"
                                                            Foreground="#B0B0B0"
                                                            Text="{Binding LastUpdateDisplay}" />
                                                    </Border>
                                                </Grid>

                                                <!--  Details section below image  -->
                                                <StackPanel Grid.Row="1" Margin="8">
                                                    <!--  Title  -->
                                                    <TextBlock
                                                        FontSize="13"
                                                        FontWeight="SemiBold"
                                                        Foreground="{StaticResource DarkText}"
                                                        Text="{Binding Title}"
                                                        TextTrimming="CharacterEllipsis"
                                                        TextWrapping="NoWrap" />

                                                    <!--  Tag Line (subtitle/description)  -->
                                                    <TextBlock
                                                        MaxHeight="28"
                                                        Margin="0,1,0,0"
                                                        FontSize="10"
                                                        FontStyle="Italic"
                                                        Foreground="#808080"
                                                        Text="{Binding TagLine}"
                                                        TextTrimming="CharacterEllipsis"
                                                        TextWrapping="Wrap"
                                                        Visibility="{Binding TagLine, Converter={StaticResource NullToVis}}" />

                                                    <!--  Creator with icon  -->
                                                    <StackPanel Margin="0,3,0,0" Orientation="Horizontal">
                                                        <Border
                                                            Width="16"
                                                            Height="16"
                                                            Margin="0,0,4,0"
                                                            CornerRadius="8"
                                                            Visibility="{Binding IconUrl, Converter={StaticResource NullToVis}}">
                                                            <Border.Background>
                                                                <ImageBrush ImageSource="{Binding IconUrl}" Stretch="UniformToFill" />
                                                            </Border.Background>
                                                        </Border>
                                                        <TextBlock
                                                            VerticalAlignment="Center"
                                                            FontSize="12"
                                                            Foreground="{StaticResource DarkTextSecondary}"
                                                            Text="{Binding Creator}" />
                                                    </StackPanel>

                                                    <!--  Stats Row 1: Downloads, Rating with count  -->
                                                    <Grid Margin="0,4,0,0">
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="Auto" />
                                                            <ColumnDefinition Width="Auto" />
                                                            <ColumnDefinition Width="Auto" />
                                                            <ColumnDefinition Width="*" />
                                                            <ColumnDefinition Width="Auto" />
                                                        </Grid.ColumnDefinitions>

                                                        <!--  Downloads  -->
                                                        <TextBlock
                                                            Grid.Column="0"
                                                            Margin="0,0,10,0"
                                                            FontSize="11"
                                                            Foreground="{StaticResource DarkTextSecondary}"
                                                            ToolTip="Download count">
                                                            <Run Text="â¬‡" />
                                                            <Run Text="{Binding DownloadCount, Mode=OneWay}" />
                                                        </TextBlock>

                                                        <!--  Rating with count  -->
                                                        <TextBlock
                                                            Grid.Column="1"
                                                            Margin="0,0,10,0"
                                                            FontSize="11"
                                                            Foreground="{StaticResource DarkTextSecondary}"
                                                            ToolTip="Rating (number of ratings)">
                                                            <Run Text="â­" />
                                                            <Run Text="{Binding RatingDisplay, Mode=OneWay}" />
                                                        </TextBlock>

                                                        <!--  Dependencies count  -->
                                                        <TextBlock
                                                            Grid.Column="2"
                                                            FontSize="10"
                                                            Foreground="#E57373"
                                                            ToolTip="Number of dependencies required"
                                                            Visibility="{Binding HasDependencies, Converter={StaticResource BoolToVis}}">
                                                            <Run Text="ðŸ“¦" />
                                                            <Run Text="{Binding DependencyDisplay, Mode=OneWay}" />
                                                        </TextBlock>

                                                        <!--  Type Badge  -->
                                                        <Border
                                                            Grid.Column="4"
                                                            Padding="6,2"
                                                            HorizontalAlignment="Right"
                                                            Background="#2196F3"
                                                            CornerRadius="2">
                                                            <TextBlock
                                                                FontSize="11"
                                                                Foreground="White"
                                                                Text="{Binding Type}" />
                                                        </Border>
                                                    </Grid>

                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Grid>
                </Border>

                <!--  Footer with Pagination  -->
                <Grid Grid.Row="3" Margin="0,8,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <!--  Status and Download Queue Button  -->
                    <StackPanel
                        Grid.Column="0"
                        VerticalAlignment="Center"
                        Orientation="Horizontal">
                        <!--  Loading Spinner  -->
                        <Grid
                            x:Name="StatusLoadingSpinner"
                            Width="16"
                            Height="16"
                            Margin="0,0,8,0"
                            Visibility="Collapsed">
                            <ProgressBar Foreground="#FF4A90D9" IsIndeterminate="True" />
                        </Grid>

                        <TextBlock
                            x:Name="StatusText"
                            VerticalAlignment="Center"
                            Foreground="{StaticResource DarkText}"
                            Text="Ready" />

                        <!--  Download Queue Button  -->
                        <Button
                            x:Name="DownloadQueueButton"
                            Margin="16,0,0,0"
                            Padding="8,4"
                            Click="DownloadQueueButton_Click"
                            Visibility="Collapsed">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Background" Value="#FF2196F3" />
                                    <Setter Property="Foreground" Value="White" />
                                    <Setter Property="BorderBrush" Value="#FF1976D2" />
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Border
                                                    x:Name="bd"
                                                    Padding="{TemplateBinding Padding}"
                                                    Background="{TemplateBinding Background}"
                                                    BorderBrush="{TemplateBinding BorderBrush}"
                                                    BorderThickness="1"
                                                    CornerRadius="3">
                                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="bd" Property="Background" Value="#FF42A5F5" />
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </Button.Style>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="â¬‡ Downloads: " />
                                <TextBlock
                                    x:Name="DownloadQueueCountText"
                                    FontWeight="Bold"
                                    Text="0" />
                            </StackPanel>
                        </Button>
                    </StackPanel>

                    <!--  Download Queue Popup  -->
                    <Popup
                        x:Name="DownloadQueuePopup"
                        Grid.Column="0"
                        AllowsTransparency="True"
                        Placement="Top"
                        PlacementTarget="{Binding ElementName=DownloadQueueButton}"
                        StaysOpen="False">
                        <Border
                            Width="400"
                            MaxHeight="350"
                            Background="#FF252525"
                            BorderBrush="{StaticResource DarkBorder}"
                            BorderThickness="1"
                            CornerRadius="4">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="*" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>

                                <!--  Header  -->
                                <Border
                                    Grid.Row="0"
                                    Padding="10,8"
                                    Background="#FF1E1E1E"
                                    CornerRadius="4,4,0,0">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>
                                        <TextBlock
                                            Grid.Column="0"
                                            FontSize="13"
                                            FontWeight="SemiBold"
                                            Foreground="{StaticResource DarkText}"
                                            Text="ðŸ“¥ Download Queue" />
                                        <Button
                                            x:Name="OpenDownloadingButton"
                                            Grid.Column="1"
                                            Margin="0,0,8,0"
                                            Padding="6,2"
                                            Click="OpenDownloading_Click"
                                            Content="ðŸ“‚ View Details"
                                            FontSize="10"
                                            ToolTip="Open detail panels for downloading resources"
                                            Visibility="Collapsed">
                                            <Button.Style>
                                                <Style TargetType="Button">
                                                    <Setter Property="Background" Value="#FF404040" />
                                                    <Setter Property="Foreground" Value="{StaticResource DarkText}" />
                                                    <Setter Property="BorderBrush" Value="{StaticResource DarkBorder}" />
                                                    <Setter Property="Template">
                                                        <Setter.Value>
                                                            <ControlTemplate TargetType="Button">
                                                                <Border
                                                                    x:Name="bd"
                                                                    Background="{TemplateBinding Background}"
                                                                    BorderBrush="{TemplateBinding BorderBrush}"
                                                                    BorderThickness="1"
                                                                    CornerRadius="3">
                                                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                                                                </Border>
                                                                <ControlTemplate.Triggers>
                                                                    <Trigger Property="IsMouseOver" Value="True">
                                                                        <Setter TargetName="bd" Property="Background" Value="#FF555555" />
                                                                    </Trigger>
                                                                </ControlTemplate.Triggers>
                                                            </ControlTemplate>
                                                        </Setter.Value>
                                                    </Setter>
                                                </Style>
                                            </Button.Style>
                                        </Button>
                                        <Button
                                            Grid.Column="2"
                                            Padding="6,2"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            Click="CloseDownloadQueuePopup_Click"
                                            Content="âœ•"
                                            FontSize="10"
                                            Foreground="{StaticResource DarkTextSecondary}" />
                                    </Grid>
                                </Border>

                                <!--  Queue List  -->
                                <ScrollViewer
                                    Grid.Row="1"
                                    MaxHeight="250"
                                    VerticalScrollBarVisibility="Auto">
                                    <ItemsControl x:Name="DownloadQueueList" Margin="6">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border
                                                    Margin="0,2"
                                                    Padding="8,6"
                                                    Background="{StaticResource DarkControlBackground}"
                                                    BorderBrush="{StaticResource DarkBorder}"
                                                    BorderThickness="1"
                                                    CornerRadius="3">
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="*" />
                                                            <ColumnDefinition Width="Auto" />
                                                        </Grid.ColumnDefinitions>
                                                        <Grid.RowDefinitions>
                                                            <RowDefinition Height="Auto" />
                                                            <RowDefinition Height="Auto" />
                                                            <RowDefinition Height="Auto" />
                                                        </Grid.RowDefinitions>

                                                        <!--  Package Name  -->
                                                        <TextBlock
                                                            Grid.Row="0"
                                                            Grid.Column="0"
                                                            FontSize="11"
                                                            FontWeight="SemiBold"
                                                            Foreground="{StaticResource DarkText}"
                                                            Text="{Binding PackageName}"
                                                            TextTrimming="CharacterEllipsis" />

                                                        <!--  Cancel Button - Always visible when download is active  -->
                                                        <Button
                                                            Grid.Row="0"
                                                            Grid.RowSpan="2"
                                                            Grid.Column="1"
                                                            Width="28"
                                                            Height="28"
                                                            Margin="6,0,0,0"
                                                            Padding="0"
                                                            VerticalAlignment="Center"
                                                            Click="CancelDownload_Click"
                                                            FontSize="14"
                                                            FontWeight="Bold"
                                                            Tag="{Binding}"
                                                            ToolTip="Cancel Download"
                                                            Visibility="{Binding CanCancel, Converter={StaticResource BoolToVis}}">
                                                            <Button.Style>
                                                                <Style TargetType="Button">
                                                                    <Setter Property="Background" Value="#FFCC3333" />
                                                                    <Setter Property="Foreground" Value="White" />
                                                                    <Setter Property="BorderBrush" Value="#FF992222" />
                                                                    <Setter Property="Template">
                                                                        <Setter.Value>
                                                                            <ControlTemplate TargetType="Button">
                                                                                <Border
                                                                                    x:Name="bd"
                                                                                    Background="{TemplateBinding Background}"
                                                                                    BorderBrush="{TemplateBinding BorderBrush}"
                                                                                    BorderThickness="1"
                                                                                    CornerRadius="4">
                                                                                    <TextBlock
                                                                                        HorizontalAlignment="Center"
                                                                                        VerticalAlignment="Center"
                                                                                        FontSize="14"
                                                                                        FontWeight="Bold"
                                                                                        Foreground="White"
                                                                                        Text="âœ•" />
                                                                                </Border>
                                                                                <ControlTemplate.Triggers>
                                                                                    <Trigger Property="IsMouseOver" Value="True">
                                                                                        <Setter TargetName="bd" Property="Background" Value="#FFEE5555" />
                                                                                    </Trigger>
                                                                                </ControlTemplate.Triggers>
                                                                            </ControlTemplate>
                                                                        </Setter.Value>
                                                                    </Setter>
                                                                </Style>
                                                            </Button.Style>
                                                        </Button>

                                                        <!--  Status and Progress Text  -->
                                                        <StackPanel
                                                            Grid.Row="1"
                                                            Grid.Column="0"
                                                            Margin="0,2,0,0"
                                                            Orientation="Horizontal">
                                                            <TextBlock
                                                                FontSize="10"
                                                                Foreground="{StaticResource DarkTextSecondary}"
                                                                Text="{Binding StatusText}" />
                                                            <TextBlock
                                                                Margin="8,0,0,0"
                                                                FontSize="10"
                                                                Foreground="{StaticResource DarkTextSecondary}"
                                                                Text="{Binding ProgressText}" />
                                                        </StackPanel>

                                                        <!--  Progress Bar  -->
                                                        <ProgressBar
                                                            Grid.Row="2"
                                                            Grid.Column="0"
                                                            Grid.ColumnSpan="2"
                                                            Height="4"
                                                            Margin="0,4,0,0"
                                                            Background="#FF2B2B2B"
                                                            Foreground="#FF4A90D9"
                                                            Maximum="100"
                                                            Value="{Binding ProgressPercentage}" />
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>

                                <!--  Footer with Cancel All  -->
                                <Border
                                    Grid.Row="2"
                                    Padding="8"
                                    Background="#FF1E1E1E"
                                    CornerRadius="0,0,4,4">
                                    <Button
                                        x:Name="CancelAllDownloadsButton"
                                        Padding="10,4"
                                        HorizontalAlignment="Right"
                                        Click="CancelAllDownloads_Click"
                                        Content="Cancel All"
                                        FontSize="11">
                                        <Button.Style>
                                            <Style TargetType="Button">
                                                <Setter Property="Background" Value="#FF8B0000" />
                                                <Setter Property="Foreground" Value="White" />
                                                <Setter Property="BorderBrush" Value="#FF6B0000" />
                                                <Setter Property="Template">
                                                    <Setter.Value>
                                                        <ControlTemplate TargetType="Button">
                                                            <Border
                                                                x:Name="bd"
                                                                Padding="{TemplateBinding Padding}"
                                                                Background="{TemplateBinding Background}"
                                                                BorderBrush="{TemplateBinding BorderBrush}"
                                                                BorderThickness="1"
                                                                CornerRadius="3">
                                                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                                                            </Border>
                                                            <ControlTemplate.Triggers>
                                                                <Trigger Property="IsMouseOver" Value="True">
                                                                    <Setter TargetName="bd" Property="Background" Value="#FFCD5C5C" />
                                                                </Trigger>
                                                            </ControlTemplate.Triggers>
                                                        </ControlTemplate>
                                                    </Setter.Value>
                                                </Setter>
                                            </Style>
                                        </Button.Style>
                                    </Button>
                                </Border>
                            </Grid>
                        </Border>
                    </Popup>

                    <!--  Pagination  -->
                    <StackPanel
                        Grid.Column="1"
                        HorizontalAlignment="Center"
                        Orientation="Horizontal">
                        <Button
                            x:Name="FirstPageButton"
                            Margin="0,0,4,0"
                            Padding="12,4"
                            Click="FirstPage_Click"
                            Content="â® First" />
                        <Button
                            x:Name="PrevPageButton"
                            Margin="0,0,4,0"
                            Padding="12,4"
                            Click="PrevPage_Click"
                            Content="â—€ Prev" />
                        <TextBlock
                            x:Name="PageInfoText"
                            Margin="8,0"
                            VerticalAlignment="Center"
                            Foreground="{StaticResource DarkText}"
                            Text="Page 1 of 1" />
                        <Button
                            x:Name="NextPageButton"
                            Margin="4,0,0,0"
                            Padding="12,4"
                            Click="NextPage_Click"
                            Content="Next â–¶" />
                    </StackPanel>

                    <!--  Total Count  -->
                    <TextBlock
                        x:Name="TotalCountText"
                        Grid.Column="2"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Center"
                        Foreground="{StaticResource DarkText}"
                        Text="Total: 0" />
                </Grid>
            </Grid>

            <!--  Detail Side Panel (Files Only)  -->
            <Grid
                x:Name="DetailPanel"
                Grid.Column="2"
                Background="{StaticResource DarkCardBackground}">
                <!--  Toggle Tab Button - positioned on left edge  -->
                <Button
                    x:Name="TogglePanelButton"
                    Width="20"
                    Height="60"
                    Margin="-10,0,0,0"
                    Padding="0"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Center"
                    Panel.ZIndex="100"
                    Background="#404040"
                    BorderBrush="{StaticResource DarkBorder}"
                    BorderThickness="1,1,0,1"
                    Click="TogglePanel_Click"
                    Content="â–¶"
                    FontSize="10"
                    ToolTip="Hide details panel">
                    <Button.Resources>
                        <Style TargetType="Border">
                            <Setter Property="CornerRadius" Value="4,0,0,4" />
                        </Style>
                    </Button.Resources>
                </Button>

                <!--  Detail Panel Content  -->
                <ScrollViewer
                    Margin="12,0,0,0"
                    HorizontalScrollBarVisibility="Disabled"
                    VerticalScrollBarVisibility="Auto">
                    <StackPanel x:Name="DetailContent" Margin="8,12,12,12">
                        <!--  Resource Header Row with Title Only  -->
                        <Grid Margin="0,0,0,4">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <!--  Title  -->
                            <StackPanel
                                Grid.Column="0"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                Orientation="Horizontal">
                                <TextBlock
                                    x:Name="DetailTitle"
                                    VerticalAlignment="Center"
                                    FontSize="18"
                                    FontWeight="SemiBold"
                                    Foreground="{StaticResource DarkText}"
                                    Text=""
                                    TextTrimming="CharacterEllipsis" />
                            </StackPanel>
                        </Grid>

                        <!--  Tag Line  -->
                        <TextBlock
                            x:Name="DetailTagLine"
                            Margin="0,2,0,0"
                            HorizontalAlignment="Center"
                            FontSize="12"
                            FontStyle="Italic"
                            Foreground="#808080"
                            Text=""
                            TextAlignment="Center"
                            TextWrapping="Wrap"
                            Visibility="Collapsed" />

                        <!--  Creator Row with Icon and Filter Link  -->
                        <StackPanel
                            MaxWidth="420"
                            Margin="0,6,0,0"
                            HorizontalAlignment="Center"
                            Orientation="Horizontal">
                            <Border
                                x:Name="DetailCreatorIcon"
                                Width="30"
                                Height="30"
                                Margin="0,0,6,0"
                                CornerRadius="10"
                                Visibility="Collapsed">
                                <Border.Background>
                                    <ImageBrush x:Name="DetailCreatorIconBrush" Stretch="UniformToFill" />
                                </Border.Background>
                            </Border>
                            <TextBlock
                                x:Name="DetailCreator"
                                VerticalAlignment="Center"
                                Cursor="Hand"
                                FontSize="14"
                                Foreground="#4A90D9"
                                MouseLeftButtonDown="DetailCreator_Click"
                                Text=""
                                TextDecorations="Underline"
                                ToolTip="Click to filter by this creator" />
                            <!--  Support Creator Link  -->
                            <TextBlock
                                x:Name="SupportCreatorButton"
                                Margin="4,0,0,0"
                                VerticalAlignment="Center"
                                Cursor="Hand"
                                FontSize="14"
                                Foreground="#E85B9C"
                                MouseLeftButtonDown="SupportCreator_Click"
                                Text="( â™¥ï¸ Support Author )"
                                TextDecorations="Underline"
                                ToolTip="Open creator's support/promotional page"
                                Visibility="Collapsed" />
                        </StackPanel>

                        <!--  Navigation Stack Controls Row  -->
                        <StackPanel
                            x:Name="DetailStackPanel"
                            Margin="0,8,0,0"
                            HorizontalAlignment="Center"
                            Orientation="Horizontal"
                            Visibility="Collapsed">
                            <TextBlock
                                x:Name="DetailStackIndicator"
                                VerticalAlignment="Center"
                                FontSize="11"
                                FontWeight="SemiBold"
                                Foreground="{StaticResource DarkTextSecondary}"
                                Text="" />
                            <Button
                                x:Name="StackDropdownButton"
                                Width="20"
                                Height="20"
                                Margin="6,0,0,0"
                                Padding="0"
                                VerticalAlignment="Center"
                                Click="StackDropdownButton_Click"
                                Content="â–¼"
                                FontSize="9"
                                ToolTip="Show all items in stack - click to navigate">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Background" Value="Transparent" />
                                        <Setter Property="Foreground" Value="{StaticResource DarkTextSecondary}" />
                                        <Setter Property="BorderBrush" Value="Transparent" />
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="Button">
                                                    <Border
                                                        x:Name="bd"
                                                        Background="{TemplateBinding Background}"
                                                        BorderBrush="{TemplateBinding BorderBrush}"
                                                        BorderThickness="1"
                                                        CornerRadius="3">
                                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter TargetName="bd" Property="Background" Value="#FF555555" />
                                                            <Setter Property="Foreground" Value="{StaticResource DarkText}" />
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </Button.Style>
                            </Button>
                            <Button
                                x:Name="ClearStackButton"
                                Width="20"
                                Height="20"
                                Margin="4,0,0,0"
                                Padding="0"
                                VerticalAlignment="Center"
                                Click="ClearStackButton_Click"
                                Content="âœ•"
                                FontSize="9"
                                ToolTip="Clear navigation stack">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Background" Value="Transparent" />
                                        <Setter Property="Foreground" Value="{StaticResource DarkTextSecondary}" />
                                        <Setter Property="BorderBrush" Value="Transparent" />
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="Button">
                                                    <Border
                                                        x:Name="bd"
                                                        Background="{TemplateBinding Background}"
                                                        BorderBrush="{TemplateBinding BorderBrush}"
                                                        BorderThickness="1"
                                                        CornerRadius="3">
                                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter TargetName="bd" Property="Background" Value="#FF555555" />
                                                            <Setter Property="Foreground" Value="{StaticResource DarkText}" />
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </Button.Style>
                            </Button>
                            <Popup
                                x:Name="StackDropdownPopup"
                                AllowsTransparency="True"
                                Placement="Bottom"
                                PlacementTarget="{Binding ElementName=StackDropdownButton}"
                                StaysOpen="False">
                                <Border
                                    Background="{StaticResource DarkCardBackground}"
                                    BorderBrush="{StaticResource DarkBorder}"
                                    BorderThickness="1"
                                    CornerRadius="4">
                                    <ItemsControl
                                        x:Name="StackItemsList"
                                        MaxHeight="300"
                                        Padding="4">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Button
                                                    Margin="2"
                                                    Padding="8,6"
                                                    HorizontalContentAlignment="Left"
                                                    Click="StackItem_Click"
                                                    Tag="{Binding Index}">
                                                    <Button.Style>
                                                        <Style TargetType="Button">
                                                            <Setter Property="Background" Value="Transparent" />
                                                            <Setter Property="Foreground" Value="{StaticResource DarkText}" />
                                                            <Setter Property="BorderBrush" Value="Transparent" />
                                                            <Setter Property="Template">
                                                                <Setter.Value>
                                                                    <ControlTemplate TargetType="Button">
                                                                        <Border
                                                                            x:Name="bd"
                                                                            Padding="{TemplateBinding Padding}"
                                                                            Background="{TemplateBinding Background}"
                                                                            BorderBrush="{TemplateBinding BorderBrush}"
                                                                            BorderThickness="0"
                                                                            CornerRadius="3">
                                                                            <ContentPresenter HorizontalAlignment="Left" VerticalAlignment="Center" />
                                                                        </Border>
                                                                        <ControlTemplate.Triggers>
                                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                                <Setter TargetName="bd" Property="Background" Value="#FF555555" />
                                                                            </Trigger>
                                                                        </ControlTemplate.Triggers>
                                                                    </ControlTemplate>
                                                                </Setter.Value>
                                                            </Setter>
                                                        </Style>
                                                    </Button.Style>
                                                    <StackPanel Orientation="Horizontal">
                                                        <TextBlock
                                                            Width="20"
                                                            VerticalAlignment="Center"
                                                            FontSize="10"
                                                            Foreground="{StaticResource DarkTextSecondary}"
                                                            Text="{Binding Position}" />
                                                        <TextBlock
                                                            MaxWidth="200"
                                                            VerticalAlignment="Center"
                                                            FontSize="11"
                                                            FontWeight="{Binding DisplayFontWeight}"
                                                            Foreground="{Binding DisplayForeground}"
                                                            Text="{Binding Title}"
                                                            TextTrimming="CharacterEllipsis" />
                                                    </StackPanel>
                                                </Button>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </Border>
                            </Popup>
                        </StackPanel>

                        <!--  Badges Row  -->
                        <WrapPanel
                            x:Name="DetailBadgesPanel"
                            MaxWidth="420"
                            Margin="0,8,0,0"
                            HorizontalAlignment="Center">
                            <Border
                                x:Name="DetailInLibraryBadge"
                                Margin="0,0,6,4"
                                Padding="6,3"
                                Background="#4CAF50"
                                CornerRadius="3"
                                Visibility="Collapsed">
                                <TextBlock
                                    FontSize="10"
                                    Foreground="White"
                                    Text="âœ“ In Library" />
                            </Border>
                            <Border
                                x:Name="DetailUpdateBadge"
                                Margin="0,0,6,4"
                                Padding="6,3"
                                Background="#FF9800"
                                CornerRadius="3"
                                Visibility="Collapsed">
                                <TextBlock
                                    FontSize="10"
                                    Foreground="White"
                                    Text="â¬† Update Available" />
                            </Border>
                            <Border
                                x:Name="DetailExternalBadge"
                                Margin="0,0,6,4"
                                Padding="6,3"
                                Background="#795548"
                                CornerRadius="3"
                                ToolTip="Requires external download"
                                Visibility="Collapsed">
                                <TextBlock
                                    FontSize="10"
                                    Foreground="White"
                                    Text="ðŸ”— External" />
                            </Border>
                        </WrapPanel>

                        <!--  Resource Image  -->
                        <Border
                            x:Name="DetailImageBorder"
                            Margin="0,10,0,0"
                            Padding="4"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Top"
                            Background="#FF1A1A1A"
                            BorderBrush="#FF4A4A4A"
                            BorderThickness="1"
                            CornerRadius="4">
                            <Image
                                x:Name="DetailImage"
                                MaxHeight="500"
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Top"
                                RenderOptions.BitmapScalingMode="HighQuality"
                                Stretch="Uniform"
                                StretchDirection="DownOnly" />
                        </Border>

                        <!--  Stats Row (downloads, rating, deps, size, last update, license)  -->
                        <WrapPanel
                            MaxWidth="420"
                            Margin="0,8,0,0"
                            HorizontalAlignment="Center">
                            <TextBlock
                                x:Name="DetailCategory"
                                Margin="0,0,14,4"
                                VerticalAlignment="Center"
                                Cursor="Hand"
                                FontSize="12"
                                Foreground="#4A90D9"
                                MouseLeftButtonDown="DetailCategory_Click"
                                Text=""
                                TextDecorations="Underline"
                                ToolTip="Click to filter by this category"
                                Visibility="Collapsed" />
                            <TextBlock
                                x:Name="DetailDownloads"
                                Margin="0,0,14,4"
                                FontSize="12"
                                Foreground="{StaticResource DarkTextSecondary}"
                                Text=""
                                ToolTip="Download count" />
                            <TextBlock
                                x:Name="DetailRating"
                                Margin="0,0,14,4"
                                FontSize="12"
                                Foreground="{StaticResource DarkTextSecondary}"
                                Text=""
                                ToolTip="Rating (number of ratings)" />
                            <TextBlock
                                x:Name="DetailDependencies"
                                Margin="0,0,14,4"
                                FontSize="12"
                                Foreground="#E57373"
                                Text=""
                                ToolTip="Number of dependencies required"
                                Visibility="Collapsed" />
                            <TextBlock
                                x:Name="DetailFileSize"
                                Margin="0,0,14,4"
                                FontSize="12"
                                Foreground="{StaticResource DarkTextSecondary}"
                                Text=""
                                ToolTip="Total file size"
                                Visibility="Collapsed" />
                            <TextBlock
                                x:Name="DetailLastUpdate"
                                Margin="0,0,4,4"
                                FontSize="12"
                                Foreground="#909090"
                                Text=""
                                ToolTip="Last updated"
                                Visibility="Collapsed" />
                        </WrapPanel>

                        <!--  Tags Section (single row, clickable)  -->
                        <TextBlock
                            x:Name="DetailTagsPanel"
                            MaxWidth="420"
                            Margin="0,4,0,0"
                            HorizontalAlignment="Center"
                            FontSize="12"
                            Foreground="#707070"
                            TextWrapping="Wrap"
                            Visibility="Collapsed" />

                        <!--  Separator  -->
                        <Border
                            Height="1"
                            Margin="0,12,0,10"
                            Background="{StaticResource DarkBorder}" />

                        <!--  Files Section Header  -->
                        <TextBlock
                            FontSize="13"
                            FontWeight="SemiBold"
                            Foreground="{StaticResource DarkText}"
                            Text="ðŸ“¦ Package Files" />

                        <!--  Download All Button / Progress Bar  -->
                        <Grid x:Name="DownloadAllContainer" Margin="0,6,0,10">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <!--  Download Button  -->
                            <Button
                                x:Name="DownloadAllButton"
                                Grid.Row="0"
                                Padding="10,8"
                                HorizontalAlignment="Stretch"
                                Click="DownloadAll_Click"
                                Content="â¬‡ Download All"
                                FontSize="12"
                                FontWeight="SemiBold" />

                            <!--  Hidden placeholder for CancelAllDetailButton (actual button is in progress container)  -->
                            <Border x:Name="CancelAllDetailButton" Visibility="Collapsed" />

                            <!--  Old Version Handling Dropdown  -->
                            <Grid Grid.Row="1" Margin="0,8,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>

                                <!--  Info Icon with Tooltip  -->
                                <TextBlock
                                    Grid.Column="0"
                                    Margin="0,0,4,0"
                                    VerticalAlignment="Center"
                                    Cursor="Help"
                                    FontSize="12"
                                    Foreground="{StaticResource DarkTextSecondary}"
                                    Text="â„¹">
                                    <TextBlock.ToolTip>
                                        <ToolTip
                                            MaxWidth="300"
                                            Padding="8"
                                            Background="{StaticResource DarkCardBackground}"
                                            BorderBrush="{StaticResource DarkBorder}"
                                            Foreground="{StaticResource DarkText}">
                                            <TextBlock LineHeight="16" TextWrapping="Wrap">
                                                <Run FontWeight="SemiBold" Text="No Change:" />
                                                <LineBreak />
                                                <Run Text="Keep all old versions in their original location" />
                                                <LineBreak />
                                                <LineBreak />
                                                <Run FontWeight="SemiBold" Text="Archive All Old:" />
                                                <LineBreak />
                                                <Run Text="Move all old versions to \ArchivedPackages\OldPackages\" />
                                                <LineBreak />
                                                <LineBreak />
                                                <Run FontWeight="SemiBold" Text="Discard All Old:" />
                                                <LineBreak />
                                                <Run Text="Move all old versions to \DiscardedPackages\" />
                                            </TextBlock>
                                        </ToolTip>
                                    </TextBlock.ToolTip>
                                </TextBlock>

                                <TextBlock
                                    Grid.Column="1"
                                    Margin="0,0,8,0"
                                    VerticalAlignment="Center"
                                    FontSize="11"
                                    Foreground="{StaticResource DarkTextSecondary}"
                                    Text="After Update Complete -&gt;" />

                                <ComboBox
                                    x:Name="OldVersionHandlingDropdown"
                                    Grid.Column="2"
                                    HorizontalAlignment="Stretch"
                                    FontSize="11">
                                    <ComboBoxItem Content="No Change" IsSelected="True" />
                                    <ComboBoxItem Content="Archive All Old" />
                                    <ComboBoxItem Content="Discard All Old" />
                                </ComboBox>
                            </Grid>

                            <!--  Progress overlay with Cancel button (shown during downloads)  -->
                            <Grid
                                x:Name="DownloadProgressContainer"
                                Grid.Row="0"
                                Visibility="Collapsed">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <Border
                                    Grid.Column="0"
                                    Background="{StaticResource DarkControlBackground}"
                                    BorderBrush="{StaticResource DarkBorder}"
                                    BorderThickness="1"
                                    CornerRadius="3">
                                    <Grid>
                                        <!--  Progress bar background  -->
                                        <ProgressBar
                                            x:Name="DownloadAllProgressBar"
                                            Height="36"
                                            Background="#FF2B2B2B"
                                            BorderThickness="0"
                                            Foreground="#FF4A90D9"
                                            Maximum="100"
                                            Value="0" />

                                        <!--  Text overlay  -->
                                        <StackPanel
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            Orientation="Vertical">
                                            <TextBlock
                                                x:Name="DownloadProgressText"
                                                HorizontalAlignment="Center"
                                                FontSize="11"
                                                FontWeight="SemiBold"
                                                Foreground="White"
                                                Text="Downloading..." />
                                            <TextBlock
                                                x:Name="DownloadProgressDetail"
                                                HorizontalAlignment="Center"
                                                FontSize="9"
                                                Foreground="#CCCCCC"
                                                Text="" />
                                        </StackPanel>
                                    </Grid>
                                </Border>

                                <!--  Cancel All button next to progress bar  -->
                                <Button
                                    Grid.Column="1"
                                    Width="80"
                                    Margin="6,0,0,0"
                                    Padding="8,8"
                                    Click="CancelAllDetailDownloads_Click"
                                    FontSize="12"
                                    FontWeight="SemiBold"
                                    ToolTip="Cancel all active downloads">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Background" Value="#FFCC3333" />
                                            <Setter Property="Foreground" Value="White" />
                                            <Setter Property="BorderBrush" Value="#FF992222" />
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate TargetType="Button">
                                                        <Border
                                                            x:Name="bd"
                                                            Background="{TemplateBinding Background}"
                                                            BorderBrush="{TemplateBinding BorderBrush}"
                                                            BorderThickness="1"
                                                            CornerRadius="3">
                                                            <TextBlock
                                                                HorizontalAlignment="Center"
                                                                VerticalAlignment="Center"
                                                                FontSize="12"
                                                                FontWeight="SemiBold"
                                                                Foreground="White"
                                                                Text="âœ• Cancel" />
                                                        </Border>
                                                        <ControlTemplate.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter TargetName="bd" Property="Background" Value="#FFEE5555" />
                                                            </Trigger>
                                                        </ControlTemplate.Triggers>
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </Button.Style>
                                </Button>
                            </Grid>
                        </Grid>

                        <!--  Files List  -->
                        <ItemsControl x:Name="DetailFilesControl" Margin="0,0,0,0">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border
                                        Margin="0,2"
                                        Padding="6,4"
                                        Background="{StaticResource DarkControlBackground}"
                                        BorderBrush="{StaticResource DarkBorder}"
                                        BorderThickness="1"
                                        CornerRadius="3"
                                        Visibility="{Binding Filename, Converter={StaticResource NullToVis}}">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                            <!--  Filename and info  -->
                                            <StackPanel Grid.Column="0" VerticalAlignment="Center">
                                                <TextBlock
                                                    FontSize="12"
                                                    FontWeight="SemiBold"
                                                    Foreground="{StaticResource DarkText}"
                                                    Text="{Binding Filename}"
                                                    TextTrimming="CharacterEllipsis" />
                                                <StackPanel Margin="0,1,0,0" Orientation="Horizontal">
                                                    <TextBlock
                                                        FontSize="10"
                                                        Foreground="{StaticResource DarkTextSecondary}"
                                                        Text="{Binding FileSizeFormatted}" />
                                                    <TextBlock
                                                        Margin="6,0,0,0"
                                                        FontSize="10"
                                                        Foreground="{Binding StatusColor}"
                                                        Text="{Binding Status}" />
                                                </StackPanel>
                                            </StackPanel>

                                            <!--  Download/Installed Button - always enabled, click opens location if installed  -->
                                            <Button
                                                Grid.Column="1"
                                                Width="28"
                                                Height="28"
                                                Margin="6,0,0,0"
                                                Padding="0"
                                                Click="DownloadFile_Click"
                                                Content="{Binding ButtonText}"
                                                FontSize="14"
                                                Tag="{Binding}">
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Background" Value="#FF333333" />
                                                        <Setter Property="Foreground" Value="#FFE0E0E0" />
                                                        <Setter Property="BorderBrush" Value="#FF4A4A4A" />
                                                        <Setter Property="ToolTip" Value="Download" />
                                                        <Setter Property="Template">
                                                            <Setter.Value>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border
                                                                        x:Name="bd"
                                                                        Background="{TemplateBinding Background}"
                                                                        BorderBrush="{TemplateBinding BorderBrush}"
                                                                        BorderThickness="1"
                                                                        CornerRadius="3">
                                                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                                                                    </Border>
                                                                    <ControlTemplate.Triggers>
                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                            <Setter TargetName="bd" Property="BorderBrush" Value="#FFFFFFFF" />
                                                                            <Setter TargetName="bd" Property="Background" Value="#FF454545" />
                                                                        </Trigger>
                                                                    </ControlTemplate.Triggers>
                                                                </ControlTemplate>
                                                            </Setter.Value>
                                                        </Setter>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding IsInstalled}" Value="True">
                                                                <Setter Property="Background" Value="#FF2E7D32" />
                                                                <Setter Property="Foreground" Value="White" />
                                                                <Setter Property="ToolTip" Value="Open in Explorer" />
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding CanDownload}" Value="False">
                                                                <Setter Property="Background" Value="#FF2A2A2A" />
                                                                <Setter Property="Foreground" Value="#FF888888" />
                                                            </DataTrigger>
                                                            <!--  HasUpdate trigger must come after IsInstalled to take priority  -->
                                                            <DataTrigger Binding="{Binding HasUpdate}" Value="True">
                                                                <Setter Property="Background" Value="#FFFF8C00" />
                                                                <Setter Property="Foreground" Value="White" />
                                                                <Setter Property="ToolTip" Value="Download Update" />
                                                            </DataTrigger>
                                                            <!--  IsDownloading trigger - show cancel button (highest priority)  -->
                                                            <DataTrigger Binding="{Binding IsDownloading}" Value="True">
                                                                <Setter Property="Background" Value="#FFCC3333" />
                                                                <Setter Property="Foreground" Value="White" />
                                                                <Setter Property="Content" Value="âœ•" />
                                                                <Setter Property="ToolTip" Value="Cancel Download" />
                                                                <Setter Property="FontWeight" Value="Bold" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                            </Button>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <!--  Dependencies Section  -->
                        <TextBlock
                            x:Name="DependenciesHeader"
                            Margin="0,12,0,0"
                            FontSize="13"
                            FontWeight="SemiBold"
                            Foreground="{StaticResource DarkText}"
                            Text="ðŸ”— Dependencies"
                            Visibility="Collapsed" />

                        <ItemsControl x:Name="DetailDependenciesControl" Margin="0,6,0,0">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border
                                        Margin="0,2"
                                        Padding="6,4"
                                        Background="{StaticResource DarkControlBackground}"
                                        BorderBrush="{StaticResource DarkBorder}"
                                        BorderThickness="1"
                                        CornerRadius="3"
                                        Visibility="{Binding Filename, Converter={StaticResource NullToVis}}">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                            <!--  Filename and status  -->
                                            <StackPanel Grid.Column="0" VerticalAlignment="Center">
                                                <TextBlock
                                                    FontSize="12"
                                                    Foreground="{StaticResource DarkText}"
                                                    Text="{Binding Filename}"
                                                    TextTrimming="CharacterEllipsis" />
                                                <TextBlock
                                                    Margin="0,1,0,0"
                                                    FontSize="10"
                                                    Foreground="{Binding StatusColor}"
                                                    Text="{Binding Status}" />
                                            </StackPanel>

                                            <!--  Download/Installed Button - always enabled, click opens location if installed  -->
                                            <Button
                                                Grid.Column="1"
                                                Width="28"
                                                Height="28"
                                                Margin="6,0,0,0"
                                                Padding="0"
                                                Click="DownloadFile_Click"
                                                Content="{Binding ButtonText}"
                                                FontSize="14"
                                                Tag="{Binding}">
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Background" Value="#FF333333" />
                                                        <Setter Property="Foreground" Value="#FFE0E0E0" />
                                                        <Setter Property="BorderBrush" Value="#FF4A4A4A" />
                                                        <Setter Property="ToolTip" Value="Download" />
                                                        <Setter Property="Template">
                                                            <Setter.Value>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border
                                                                        x:Name="bd"
                                                                        Background="{TemplateBinding Background}"
                                                                        BorderBrush="{TemplateBinding BorderBrush}"
                                                                        BorderThickness="1"
                                                                        CornerRadius="3">
                                                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                                                                    </Border>
                                                                    <ControlTemplate.Triggers>
                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                            <Setter TargetName="bd" Property="BorderBrush" Value="#FFFFFFFF" />
                                                                            <Setter TargetName="bd" Property="Background" Value="#FF454545" />
                                                                        </Trigger>
                                                                    </ControlTemplate.Triggers>
                                                                </ControlTemplate>
                                                            </Setter.Value>
                                                        </Setter>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding IsInstalled}" Value="True">
                                                                <Setter Property="Background" Value="#FF2E7D32" />
                                                                <Setter Property="Foreground" Value="White" />
                                                                <Setter Property="ToolTip" Value="Open in Explorer" />
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding CanDownload}" Value="False">
                                                                <Setter Property="Background" Value="#FF2A2A2A" />
                                                                <Setter Property="Foreground" Value="#FF888888" />
                                                            </DataTrigger>
                                                            <!--  HasUpdate trigger must come after IsInstalled to take priority  -->
                                                            <DataTrigger Binding="{Binding HasUpdate}" Value="True">
                                                                <Setter Property="Background" Value="#FFFF8C00" />
                                                                <Setter Property="Foreground" Value="White" />
                                                                <Setter Property="ToolTip" Value="Download Update" />
                                                            </DataTrigger>
                                                            <!--  IsDownloading trigger - show cancel button (highest priority)  -->
                                                            <DataTrigger Binding="{Binding IsDownloading}" Value="True">
                                                                <Setter Property="Background" Value="#FFCC3333" />
                                                                <Setter Property="Foreground" Value="White" />
                                                                <Setter Property="Content" Value="âœ•" />
                                                                <Setter Property="ToolTip" Value="Cancel Download" />
                                                                <Setter Property="FontWeight" Value="Bold" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                            </Button>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Grid>
    </Grid>
</Window>
